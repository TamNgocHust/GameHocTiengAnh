<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Chọn Bài Học</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@600;800&display=swap" rel="stylesheet">
  <style>
    /* --- GIỮ NGUYÊN CSS CŨ --- */
    * { margin: 0; padding: 0; box-sizing: border-box; font-family: "Poppins", sans-serif; }
    body {
      height: 100vh;
      background: url('screen/phongnen.jpg') no-repeat center center fixed;
      background-size: cover;
      display: flex; justify-content: center; align-items: center;
    }
    .overlay { position: absolute; inset: 0; background: rgba(0, 0, 0, 0.4); backdrop-filter: blur(5px); }

    .card {
      position: relative; z-index: 10;
      width: 900px; max-width: 95vw; height: 85vh;
      background: rgba(255, 255, 255, 0.95);
      border-radius: 30px; border: 4px solid #ff8c42;
      box-shadow: 0 20px 50px rgba(0,0,0,0.5);
      display: flex; flex-direction: column; padding: 30px;
      animation: popIn 0.4s ease-out;
    }

    .header { text-align: center; margin-bottom: 20px; }
    .title { font-size: 2.5rem; color: #d84315; font-weight: 800; text-transform: uppercase; }
    .subtitle { font-size: 1.2rem; color: #555; font-weight: 600; }

    .unit-grid {
      flex: 1; overflow-y: auto;
      display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 20px; padding: 10px;
    }

    .unit-grid::-webkit-scrollbar { width: 8px; }
    .unit-grid::-webkit-scrollbar-thumb { background: #ffb74d; border-radius: 4px; }

    .unit-btn {
      background: linear-gradient(135deg, #fff9c4 0%, #fff 100%);
      border: 2px solid #fbc02d; border-radius: 20px;
      padding: 20px; cursor: pointer; text-align: center;
      box-shadow: 0 5px 0 #f9a825; transition: transform 0.2s;
      display: flex; flex-direction: column; justify-content: center; align-items: center;
      min-height: 120px;
    }
    .unit-btn:hover { transform: translateY(-5px); background: #fffde7; }
    .unit-btn:active { transform: translateY(2px); box-shadow: 0 2px 0 #f9a825; }

    .unit-num { font-size: 1.2rem; font-weight: 800; color: #ef6c00; margin-bottom: 5px; }
    .unit-name { font-size: 1rem; font-weight: 600; color: #333; line-height: 1.3; }

    .btn-back {
      margin-top: 20px; align-self: center;
      padding: 12px 30px; border-radius: 50px; border: none;
      background: #ff5722; color: #fff; font-weight: 700; cursor: pointer;
      box-shadow: 0 5px 0 #bf360c;
    }
    .btn-back:hover { transform: translateY(-2px); }

    @keyframes popIn { 0% { transform: scale(0.9); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
  </style>
</head>
<body>

  <div class="overlay"></div>

  <div class="card">
    <div class="header">
      <div class="title">CHỌN BÀI HỌC</div>
      <div class="subtitle" id="gradeLabel">Đang tải dữ liệu...</div>
    </div>

    <div class="unit-grid" id="unitContainer">
      </div>

    <button class="btn-back" onclick="window.location.href='GradeSelect.html'">← Chọn lại lớp</button>
  </div>

  <script>
    const API_URL = '/api/game';
    // Mặc định lớp 5 nếu chưa chọn (để test)
    const selectedGrade = localStorage.getItem('selectedGrade') || 5; 

    document.getElementById('gradeLabel').textContent = `Danh sách bài học - Lớp ${selectedGrade}`;

    async function loadUnits() {
      const container = document.getElementById('unitContainer');
      container.innerHTML = '<p style="text-align:center; width:100%">⏳ Đang tải danh sách bài học...</p>';

      try {
        const res = await fetch(`${API_URL}/units?grade=${selectedGrade}`);
        const data = await res.json();

        container.innerHTML = ''; 

        if (data.success && data.data.length > 0) {
          // --- LOGIC MỚI: DÙNG INDEX ĐỂ ĐÁNH SỐ ---
          // Biến index sẽ chạy từ 0, 1, 2, 3... tương ứng với thứ tự bài học lấy được
          data.data.forEach((unit, index) => {
            const btn = document.createElement('div');
            btn.className = 'unit-btn';
            
            // Số hiển thị chính là số thứ tự (0, 1, 2...)
            // Bất chấp ID trong database là bao nhiêu
            let displayNum = index; 

            // Xử lý tên hiển thị (Bỏ phần "Unit X:" nếu có trong tên gốc)
            let uName = unit.TopicName;
            if (uName.includes(':')) {
                uName = uName.split(':')[1].trim(); 
            }

            // Gán sự kiện click
            btn.onclick = function() {
                selectUnit(unit.TopicID, displayNum);
            };
            
            btn.innerHTML = `
              <div class="unit-num">Unit ${displayNum}</div>
              <div class="unit-name">${uName}</div>
            `;
            container.appendChild(btn);
          });
        } else {
          container.innerHTML = '<p style="text-align:center">Chưa có bài học nào cho lớp này.</p>';
        }
      } catch (err) {
        console.error(err);
        container.innerHTML = '<p style="text-align:center; color:red">Lỗi kết nối Server!</p>';
      }
    }

    function selectUnit(dbId, displayNum) {
      console.log("Đã chọn:", dbId, "Hiển thị:", displayNum);
      
      // Xóa cache cũ
      localStorage.removeItem('currentUnitId');
      localStorage.removeItem('displayUnitNumber');

      // Lưu cái mới
      localStorage.setItem('currentUnitId', dbId);        // ID thật (để gọi API câu hỏi)
      localStorage.setItem('displayUnitNumber', displayNum); // Số đẹp (để hiển thị Unit 0, 1...)
      
      // Chuyển trang
      window.location.href = 'level.html'; 
    }

    window.onload = loadUnits;
  </script>

</body>
</html>