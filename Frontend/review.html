<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>√în T·∫≠p T·ª´ V·ª±ng - Ng·ªØ Ph√°p</title>
<style>
    * { margin: 0; padding: 0; box-sizing: border-box; font-family: "Segoe UI", Arial, sans-serif; }
    
    body {
        background: url("screen/phongnen.jpg") no-repeat center center fixed; 
        background-size: cover;
        display: flex; justify-content: center; align-items: center;
        min-height: 100vh; padding: 20px;
    }

    .overlay { position: fixed; inset: 0; background: rgba(255, 255, 255, 0.4); z-index: 0;}

    /* Card Ch√≠nh */
    .review-card {
        position: relative; z-index: 1;
        width: 1200px; max-width: 95vw; height: 90vh;
        background: rgba(255, 245, 210, 0.98);
        border: 4px solid #ff8c42; border-radius: 20px;
        box-shadow: 0 15px 40px rgba(0,0,0,0.3);
        display: flex; flex-direction: column; padding: 20px;
    }

    /* Header */
    .header { 
        display: flex; justify-content: space-between; align-items: center; 
        margin-bottom: 15px; 
        flex-wrap: wrap; gap: 10px; /* ƒê·ªÉ kh√¥ng b·ªã v·ª° giao di·ªán tr√™n m√†n h√¨nh nh·ªè */
    }
    .title { font-size: 1.8rem; font-weight: bold; color: #d13625; text-transform: uppercase; }
    
    /* Khu v·ª±c ch·ª©a 2 √¥ select */
    .controls { display: flex; gap: 10px; }

    select { 
        padding: 8px 15px; font-size: 1rem; border-radius: 10px; 
        border: 2px solid #ff8c42; outline: none; background: #fff; cursor: pointer;
    }
    select:focus { border-color: #d13625; }

    /* N·ªôi dung chia 2 c·ªôt */
    .content-wrapper { display: flex; gap: 20px; flex: 1; overflow: hidden; }
    
    .panel {
        flex: 1; background: #fff; border-radius: 15px; padding: 15px;
        display: flex; flex-direction: column;
        border: 2px solid #ffe0b2;
        overflow: hidden; /* ƒê·ªÉ scroll b√™n trong */
    }

    .panel-header {
        font-size: 1.2rem; font-weight: bold; color: #e65100;
        margin-bottom: 10px; padding-bottom: 10px; border-bottom: 2px dashed #ffe0b2;
        display: flex; align-items: center; gap: 8px;
    }

    .scroll-area { flex: 1; overflow-y: auto; padding-right: 5px; }

    /* B·∫£ng T·ª´ V·ª±ng */
    table { width: 100%; border-collapse: collapse; font-size: 0.95rem; }
    th { background: #fff3e0; position: sticky; top: 0; padding: 10px; text-align: left; color: #e65100; z-index: 2;}
    td { padding: 10px; border-bottom: 1px solid #eee; vertical-align: top; }
    
    .word-text { font-weight: bold; color: #d84315; font-size: 1.05rem; }
    .word-type { font-size: 0.8rem; color: #888; font-style: italic; }
    .example-text { font-style: italic; color: #555; background: #f9f9f9; padding: 4px; border-radius: 4px; display: block; margin-top: 4px; font-size: 0.9rem;}

    /* Th·∫ª Ng·ªØ Ph√°p */
    .grammar-box {
        background: #fff8e1; border-left: 5px solid #ffb74d;
        padding: 12px; margin-bottom: 15px; border-radius: 5px;
    }
    .gm-name { font-weight: bold; color: #bf360c; font-size: 1.1rem; margin-bottom: 5px; }
    .gm-label { font-weight: bold; color: #ef6c00; font-size: 0.9rem; margin-top: 8px; display: block;}
    .gm-content { color: #333; line-height: 1.4; white-space: pre-line; }
    .gm-example { background: #fff; padding: 8px; border-radius: 5px; border: 1px dashed #ccc; margin-top: 5px; color: #2e7d32; font-weight: 500;}

    /* N√∫t v√† User */
    .top-user { position: absolute; top: -50px; right: 0; background: #fff; padding: 8px 20px; border-radius: 20px; font-weight: bold; box-shadow: 0 5px 15px rgba(0,0,0,0.2);}
    .btn-back { margin-top: 15px; align-self: flex-start; padding: 10px 25px; background: #ff8c42; color: white; border: none; border-radius: 20px; cursor: pointer; font-weight: bold; font-size: 1rem;}
    .btn-back:hover { background: #f57c00; }

</style>
</head>
<body>

    <div class="overlay"></div>

    <div class="review-card">
        <div class="top-user">User: <span id="showUser" style="color:#d84315">...</span></div>

        <div class="header">
            <div class="title">√îN T·∫¨P KI·∫æN TH·ª®C</div>
            
            <div class="controls">
                <select id="gradeSelect" onchange="loadUnitsByGrade()">
                    <option value="1">L·ªõp 1</option>
                    <option value="2">L·ªõp 2</option>
                    <option value="3">L·ªõp 3</option>
                    <option value="4">L·ªõp 4</option>
                    <option value="5" selected>L·ªõp 5</option> </select>

                <select id="unitSelect" onchange="loadReviewData()">
                    <option value="">-- ƒêang t·∫£i Unit... --</option>
                </select>
            </div>
        </div>

        <div class="content-wrapper">
            <div class="panel">
                <div class="panel-header">üìö T·ª™ V·ª∞NG (VOCABULARY)</div>
                <div class="scroll-area" id="vocabContent">
                    <p style="text-align:center; color:#888; margin-top:20px">Vui l√≤ng ch·ªçn Unit ƒë·ªÉ xem...</p>
                </div>
            </div>

            <div class="panel">
                <div class="panel-header">‚úèÔ∏è NG·ªÆ PH√ÅP (GRAMMAR)</div>
                <div class="scroll-area" id="grammarContent">
                    <p style="text-align:center; color:#888; margin-top:20px">Vui l√≤ng ch·ªçn Unit ƒë·ªÉ xem...</p>
                </div>
            </div>
        </div>

        <button class="btn-back" onclick="location.href='menu.html'">‚Üê Quay l·∫°i Menu</button>
    </div>

<script>
    const API_REVIEW = "/api/review";
    const API_GAME = "/api/game"; // API ƒë·ªÉ l·∫•y danh s√°ch Unit

    // --- 1. HI·ªÇN TH·ªä USER ---
    const fullname = localStorage.getItem("fullname");
    const username = localStorage.getItem("username");
    let displayUser = "Kh√°ch";
    if (fullname && fullname !== "null") displayUser = fullname;
    else if (username) displayUser = username;
    document.getElementById("showUser").textContent = displayUser;

    // --- 2. H√ÄM T·∫¢I DANH S√ÅCH UNIT (KHI CH·ªåN L·ªöP) ---
    async function loadUnitsByGrade() {
        const grade = document.getElementById("gradeSelect").value;
        const unitSelect = document.getElementById("unitSelect");
        
        // Reset √¥ ch·ªçn Unit
        unitSelect.innerHTML = '<option value="">‚è≥ ƒêang t·∫£i b√†i h·ªçc...</option>';
        unitSelect.disabled = true;

        try {
            const res = await fetch(`${API_GAME}/units?grade=${grade}`);
            const data = await res.json();

            unitSelect.innerHTML = '<option value="">-- Ch·ªçn b√†i h·ªçc --</option>'; // Reset l·∫°i
            
            if (data.success && data.data.length > 0) {
                // Duy·ªát qua danh s√°ch v√† t·∫°o option
                data.data.forEach((unit, index) => {
                    const option = document.createElement("option");
                    
                    // Value l√† ID th·∫≠t (ƒë·ªÉ g·ªçi API review)
                    option.value = unit.TopicID; 
                    
                    // Text hi·ªÉn th·ªã l√† s·ªë th·ª© t·ª± (Unit 0, Unit 1...) cho ƒë·∫πp
                    let uName = unit.TopicName;
                    if (uName.includes(':')) uName = uName.split(':')[1].trim();
                    
                    option.textContent = `Unit ${index}: ${uName}`;
                    unitSelect.appendChild(option);
                });
                unitSelect.disabled = false;
            } else {
                unitSelect.innerHTML = '<option value="">Kh√¥ng c√≥ b√†i h·ªçc n√†o</option>';
            }

        } catch (error) {
            console.error(error);
            unitSelect.innerHTML = '<option value="">L·ªói k·∫øt n·ªëi!</option>';
        }
    }

    // --- 3. H√ÄM T·∫¢I D·ªÆ LI·ªÜU REVIEW (KHI CH·ªåN UNIT) ---
    async function loadReviewData() {
        const unitId = document.getElementById("unitSelect").value;
        const vocabDiv = document.getElementById("vocabContent");
        const grammarDiv = document.getElementById("grammarContent");

        if (!unitId) return; // N·∫øu ch∆∞a ch·ªçn g√¨ th√¨ th√¥i

        // Hi·ªán loading
        vocabDiv.innerHTML = '<p style="text-align:center; color:blue">‚è≥ ƒêang t·∫£i t·ª´ v·ª±ng...</p>';
        grammarDiv.innerHTML = '<p style="text-align:center; color:blue">‚è≥ ƒêang t·∫£i ng·ªØ ph√°p...</p>';

        try {
            // G·ªçi API T·ª´ v·ª±ng
            const resVocab = await fetch(`${API_REVIEW}/vocab/${unitId}`);
            if (!resVocab.ok) throw new Error("L·ªói API Vocab");
            const dataVocab = await resVocab.json();
            renderVocab(dataVocab);

            // G·ªçi API Ng·ªØ ph√°p
            const resGrammar = await fetch(`${API_REVIEW}/grammar/${unitId}`);
            if (!resGrammar.ok) throw new Error("L·ªói API Grammar");
            const dataGrammar = await resGrammar.json();
            renderGrammar(dataGrammar);

        } catch (error) {
            console.error(error);
            vocabDiv.innerHTML = '<p style="text-align:center; color:red">‚ùå Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu.</p>';
            grammarDiv.innerHTML = '<p style="text-align:center; color:red">‚ùå Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu.</p>';
        }
    }

    // --- 4. C√ÅC H√ÄM RENDER (V·∫º GIAO DI·ªÜN) ---
    function renderVocab(data) {
        const container = document.getElementById("vocabContent");
        if (!data || data.length === 0) {
            container.innerHTML = '<p style="text-align:center">Ch∆∞a c√≥ d·ªØ li·ªáu t·ª´ v·ª±ng.</p>';
            return;
        }

        let html = `<table>
            <thead>
                <tr>
                    <th width="40%">T·ª´ v·ª±ng</th>
                    <th>Nghƒ©a</th>
                </tr>
            </thead>
            <tbody>`;
        
        data.forEach(item => {
            html += `
                <tr>
                    <td>
                        <div class="word-text">${item.Word}</div>
                        <div class="word-type">${item.WordType || ''}</div>
                        </td>
                    <td style="vertical-align: middle;">
                        ${item.Meaning}
                    </td>
                </tr>`;
        });
        html += '</tbody></table>';
        container.innerHTML = html;
    }

    function renderGrammar(data) {
        const container = document.getElementById("grammarContent");
        if (!data || data.length === 0) {
            container.innerHTML = '<p style="text-align:center">Ch∆∞a c√≥ d·ªØ li·ªáu ng·ªØ ph√°p.</p>';
            return;
        }

        let html = '';
        data.forEach(item => {
            html += `
                <div class="grammar-box">
                    <div class="gm-name">${item.GrammarName}</div>
                    <span class="gm-label">C·∫•u tr√∫c:</span>
                    <div class="gm-content" style="color:#d32f2f; font-weight:bold">${item.Structure}</div>
                    <span class="gm-label">C√°ch d√πng:</span>
                    <div class="gm-content">${item.Usage}</div>
                    <span class="gm-label">V√≠ d·ª•:</span>
                    <div class="gm-example">${item.Example}</div>
                </div>
            `;
        });
        container.innerHTML = html;
    }

    // --- 5. T·ª∞ ƒê·ªòNG CH·∫†Y KHI V√ÄO TRANG ---
    // M·∫∑c ƒë·ªãnh t·∫£i danh s√°ch Unit c·ªßa l·ªõp ƒëang ch·ªçn (L·ªõp 5)
    window.onload = loadUnitsByGrade;
</script>

</body>
</html>