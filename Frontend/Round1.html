<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Round 1: Word Matching - Survival Mode</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">

<style>
    /* --- CSS GI·ªÆ NGUY√äN --- */
    * { margin: 0; padding: 0; box-sizing: border-box; font-family: "Poppins", Arial, sans-serif; }

    body {
        height: 100vh; width: 100vw; background: #000;
        display: flex; justify-content: center; align-items: center; overflow: hidden;
        background-image: url('screen/mushroom.jpg'); 
        background-size: cover; background-position: center;
    }

    .bg-overlay { position: absolute; inset: 0; background: rgba(0, 0, 0, 0.4); backdrop-filter: blur(4px); z-index: 0; }
    .overlay-ui { position: fixed; inset: 0; pointer-events: none; z-index: 100; }

    .top-right {
        position: absolute; top: 15px; right: 20px;
        background: rgba(255, 245, 210, 0.95); padding: 8px 16px; border-radius: 999px;
        display: flex; align-items: center; gap: 12px; border: 2px solid #ffb347;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.25); pointer-events: auto;
    }

    .username-label { font-weight: 600; color: #553300; }
    
    .logout-btn {
        cursor: pointer; padding: 4px 10px; border-radius: 999px; border: none;
        background: #ff4b3a; color: #fff; font-size: 0.85rem;
        box-shadow: 0 3px 0 #c53120; text-transform: uppercase;
    }
    .logout-btn:hover { transform: translateY(-1px); }

    .bottom-left { position: absolute; left: 20px; bottom: 15px; pointer-events: auto; }
    .btn-back {
        padding: 7px 16px; border-radius: 999px; border: none;
        background: #ffffff; color: #553300; cursor: pointer;
        display: inline-flex; align-items: center; gap: 6px;
        box-shadow: 0 3px 0 rgba(0, 0, 0, 0.2);
        text-decoration: none; font-weight: 600; font-size: 0.9rem;
    }
    .btn-back:hover { transform: translateY(-1px); }

    /* --- GAME BOARD --- */
    #gameWrapper {
        position: relative; z-index: 10;
        width: 1000px; max-width: 95vw; height: 80vh;
        background: rgba(255, 255, 255, 0.92);
        border-radius: 20px; border: 6px solid #ff8c42;
        box-shadow: 0 15px 40px rgba(0,0,0,0.5);
        display: flex; flex-direction: column; overflow: hidden;
    }

    .game-header {
        height: 70px; background: #ffecb3;
        display: flex; align-items: center; justify-content: space-between;
        padding: 0 30px; border-bottom: 3px solid #ffd54f;
    }

    .game-title { font-size: 1.5rem; font-weight: 700; color: #d84315; }

    .game-stats {
        font-size: 1.1rem; font-weight: 600; color: #553300;
        display: flex; gap: 20px;
    }
    .stat-box span { color: #d32f2f; font-weight: 700; }

    /* --- KHU V·ª∞C N·ªêI T·ª™ --- */
    .matching-area {
        flex: 1; display: flex; padding: 20px; gap: 40px;
        overflow-y: auto; justify-content: center;
    }

    .column {
        flex: 1; display: flex; flex-direction: column;
        gap: 12px; max-width: 400px;
    }

    .col-header {
        text-align: center; font-weight: 700; color: #795548;
        margin-bottom: 5px; text-transform: uppercase; letter-spacing: 1px;
    }

    .card {
        background: #fff; border: 2px solid #ddd; border-bottom: 4px solid #ccc;
        border-radius: 12px; padding: 15px; text-align: center;
        font-size: 1rem; font-weight: 600; color: #333;
        cursor: pointer; transition: all 0.2s; user-select: none;
    }

    .card:hover { transform: translateY(-2px); border-color: #ffb74d; background: #fff8e1; }
    .card:active { transform: translateY(2px); border-bottom-width: 2px; }

    .card.selected {
        background: #ffeb3b; border-color: #fbc02d; border-bottom-color: #f9a825;
        color: #000; transform: scale(1.02);
    }

    .card.matched {
        background: #81c784; border-color: #4caf50; border-bottom-color: #388e3c;
        color: #fff; cursor: default; opacity: 0.6; pointer-events: none;
        animation: popIn 0.3s;
    }

    .card.wrong {
        background: #ef5350; border-color: #d32f2f; color: #fff;
        animation: shake 0.4s;
    }

    @keyframes shake {
        0% { transform: translateX(0); } 25% { transform: translateX(-5px); }
        50% { transform: translateX(5px); } 75% { transform: translateX(-5px); }
        100% { transform: translateX(0); }
    }

    @keyframes popIn {
        0% { transform: scale(0.8); } 50% { transform: scale(1.1); } 100% { transform: scale(1); }
    }

    #loadingOverlay, #resultOverlay {
        position: absolute; inset: 0; background: rgba(255,255,255,0.95);
        z-index: 20; display: flex; flex-direction: column;
        justify-content: center; align-items: center; text-align: center;
    }
    
    .hidden { display: none !important; }

    .result-box {
        background: #fff; padding: 30px 50px; border-radius: 20px;
        border: 4px solid #ff8c42; box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    }

    .result-title { font-size: 2rem; color: #d84315; margin-bottom: 15px; }
    .result-score { font-size: 1.5rem; color: #333; margin-bottom: 10px; }
    .result-time { font-size: 1.2rem; color: #555; margin-bottom: 25px; font-style: italic;}
    
    .btn-next {
        padding: 12px 30px; background: #4caf50; color: white;
        border: none; border-radius: 50px; font-size: 1.1rem;
        font-weight: bold; cursor: pointer; box-shadow: 0 4px 0 #2e7d32;
    }
    .btn-next:hover { transform: translateY(-2px); }

</style>
</head>
<body>

<div class="bg-overlay"></div>

<div class="overlay-ui">
    <div class="top-right">
        <span class="username-label" id="showUser">User</span>
        <button class="logout-btn" onclick="logout()">Logout</button>
    </div>
    <div class="bottom-left">
        <a href="UnitSelect.html" class="btn-back"><span>‚Üê</span> Tr·ªü l·∫°i</a>
    </div>
</div>

<div id="gameWrapper">
    <div class="game-header">
        <div class="game-title" id="gameTitleDisplay">üçÑ Round 1</div>
        <div class="game-stats">
            <div class="stat-box" style="color: #d32f2f;">L·ªói: <span id="wrongDisplay">0</span>/5</div>
            <div class="stat-box">Gh√©p ƒë√∫ng: <span id="matchCount">0</span>/10</div>
            <div class="stat-box">C√≤n l·∫°i: <span id="timerDisplay">--:--</span></div>
        </div>
    </div>

    <div id="loadingOverlay">
        <h2>ƒêang t·∫£i d·ªØ li·ªáu...</h2>
        <p>H·ªá th·ªëng ƒëang chu·∫©n b·ªã c√¢u h·ªèi cho b·∫°n.</p>
    </div>

    <div class="matching-area" id="board">
        <div class="column" id="colLeft">
            <div class="col-header">C√¢u h·ªèi / T·ª´ v·ª±ng</div>
        </div>
        <div class="column" id="colRight">
            <div class="col-header">ƒê√°p √°n / Nghƒ©a</div>
        </div>
    </div>

    <div id="resultOverlay" class="hidden">
        <div class="result-box">
            <div class="result-title" id="resultTitle">Ho√†n th√†nh!</div>
            <div class="result-score" id="resultMsg">B·∫°n ƒë·∫°t ... ƒëi·ªÉm</div>
            <div class="result-time" id="resultTime">Th·ªùi gian: 00:00</div>
            <div id="resultButtons"></div>
        </div>
    </div>
</div>

<script>
    // ============ C·∫§U H√åNH API ============
    const BASE_API_URL = '/api/game/round1'; 
    const SUBMIT_URL = '/api/game/submit-round1'; 
    
    // BI·∫æN TR·∫†NG TH√ÅI
    let GAME_DURATION = 120;
    let unitId = null;
    let selectedGrade = 5;
    let difficulty = 'normal';

    let leftSelected = null;
    let rightSelected = null;
    
    let matchesFound = 0;
    let totalPairs = 10;
    
    // Logic Survival Mode
    let wrongCount = 0;
    const MAX_WRONG = 5;
    
    let userAnswers = [];
    let timerInterval;
    let timeLeft = 0;

    // ============ KH·ªûI T·∫†O (AUTO RUN) ============
    window.onload = function() {
        const userId = localStorage.getItem("currentUserID");
        const fullname = localStorage.getItem("fullname");
        const username = localStorage.getItem("username");
        document.getElementById("showUser").textContent = fullname || username || "Guest";

        unitId = localStorage.getItem("currentUnitId");
        difficulty = localStorage.getItem("gameConfig_Diff") || 'normal';
        selectedGrade = localStorage.getItem("selectedGrade") || 5;

        if (!unitId) {
            alert("Vui l√≤ng ch·ªçn b√†i h·ªçc tr∆∞·ªõc!");
            window.location.href = "UnitSelect.html";
            return;
        }

        setupDifficulty(difficulty);
        document.getElementById("gameTitleDisplay").textContent = `üçÑ L·ªõp ${selectedGrade} - Unit ${unitId} (${capitalize(difficulty)})`;
        fetchGameData(unitId);
    };

    function setupDifficulty(diff) {
        if (diff === 'easy') GAME_DURATION = 180;
        else if (diff === 'hard') GAME_DURATION = 60;
        else GAME_DURATION = 120;
        
        timeLeft = GAME_DURATION;
        updateTimerDisplay();
    }

    function capitalize(s) { return s && s[0].toUpperCase() + s.slice(1); }

    function logout() {
        if(confirm("Tho√°t game?")) { localStorage.clear(); window.location.href = "login.html"; }
    }

    // ============ LOGIC API ============
    async function fetchGameData(id) {
        try {
            const response = await fetch(`${BASE_API_URL}/${id}?grade=${selectedGrade}`);
            const data = await response.json();

            if(data.success) {
                totalPairs = data.totalPairs;
                renderBoard(data.data);
                document.getElementById("loadingOverlay").classList.add("hidden");
                startTimer();
            } else {
                alert("L·ªói: " + data.message);
                window.location.href = 'UnitSelect.html';
            }
        } catch (error) {
            console.error("Error:", error);
            alert("L·ªói k·∫øt n·ªëi Server!");
        }
    }

    // ============ LOGIC TH·ªúI GIAN ============
    function startTimer() {
        updateTimerDisplay();
        clearInterval(timerInterval);
        timerInterval = setInterval(() => {
            timeLeft--;
            updateTimerDisplay();
            
            if (timeLeft <= 0) {
                clearInterval(timerInterval);
                showLose("H·∫øt gi·ªù! B·∫°n ch∆∞a ho√†n th√†nh.");
            }
        }, 1000);
    }

    function updateTimerDisplay() {
        let t = timeLeft < 0 ? 0 : timeLeft;
        const m = Math.floor(t / 60).toString().padStart(2,'0');
        const s = (t % 60).toString().padStart(2,'0');
        const el = document.getElementById("timerDisplay");
        el.textContent = `${m}:${s}`;
        el.style.color = t < 10 ? "red" : "#d32f2f";
    }

    function formatTimeUsed(seconds) {
        const m = Math.floor(seconds / 60).toString().padStart(2,'0');
        const s = (seconds % 60).toString().padStart(2,'0');
        return `${m}:${s}`;
    }

    // ============ RENDER GAME ============
    function renderBoard(gameData) {
        const colLeft = document.getElementById("colLeft");
        const colRight = document.getElementById("colRight");

        while (colLeft.children.length > 1) colLeft.removeChild(colLeft.lastChild);
        while (colRight.children.length > 1) colRight.removeChild(colRight.lastChild);

        gameData.leftColumn.forEach(item => colLeft.appendChild(createCard(item, "left")));
        gameData.rightColumn.forEach(item => colRight.appendChild(createCard(item, "right")));
    }

    function createCard(item, side) {
        const card = document.createElement("div");
        card.className = "card";
        card.textContent = item.text; 
        card.dataset.id = item.id; 
        card.dataset.side = side;
        card.onclick = () => handleCardClick(card, side);
        return card;
    }

    // ============ GAMEPLAY LOGIC ============
    function handleCardClick(card, side) {
        if (card.classList.contains("matched") || card.classList.contains("wrong")) return;

        if (side === "left") {
            if (leftSelected) leftSelected.classList.remove("selected");
            leftSelected = card;
        } else {
            if (rightSelected) rightSelected.classList.remove("selected");
            rightSelected = card;
        }
        card.classList.add("selected");

        if (leftSelected && rightSelected) {
            checkMatch();
        }
    }

    function checkMatch() {
        const leftId = parseInt(leftSelected.dataset.id);
        const rightId = parseInt(rightSelected.dataset.id);
        
        userAnswers.push({ leftId, rightId });

        if (leftId === rightId) {
            handleCorrect();
        } else {
            handleWrong();
        }
    }

    function handleCorrect() {
        leftSelected.classList.remove("selected");
        rightSelected.classList.remove("selected");
        
        leftSelected.classList.add("matched");
        rightSelected.classList.add("matched");
        
        leftSelected = null;
        rightSelected = null;
        matchesFound++;
        document.getElementById("matchCount").textContent = matchesFound;

        // Th·∫Øng cu·ªôc
        if (matchesFound === totalPairs) {
            clearInterval(timerInterval);
            setTimeout(() => {
                submitGame(); // G·ª≠i ƒëi·ªÉm
            }, 500);
        }
    }

    function handleWrong() {
        const l = leftSelected;
        const r = rightSelected;
        l.classList.add("wrong");
        r.classList.add("wrong");
        
        // TƒÉng l·ªói
        wrongCount++;
        document.getElementById("wrongDisplay").textContent = wrongCount;

        setTimeout(() => {
            l.classList.remove("selected", "wrong");
            r.classList.remove("selected", "wrong");
            leftSelected = null;
            rightSelected = null;

            // THUA NGAY L·∫¨P T·ª®C
            if (wrongCount > MAX_WRONG) {
                clearInterval(timerInterval);
                showLose(`B·∫°n ƒë√£ sai qu√° ${MAX_WRONG} l·∫ßn!`);
            }
        }, 500);
    }

    // ============ X·ª¨ L√ù K·∫æT QU·∫¢ ============

    async function submitGame() {
        const timeUsed = GAME_DURATION - timeLeft;
        const userId = localStorage.getItem("currentUserID");

        // T·ª± t√≠nh ƒëi·ªÉm hi·ªÉn th·ªã t·∫°m th·ªùi: 100 - (S·ªë l·ªói * 10)
        let finalScore = 100 - (wrongCount * 10);
        if (finalScore < 0) finalScore = 0;

        try {
            const payload = { 
                studentId: userId,
                gameId: 1, // Round 1
                topicId: unitId,
                timeTaken: timeUsed, 
                totalQuestions: totalPairs,
                correctCount: matchesFound,
                wrongCount: wrongCount // <--- QUAN TR·ªåNG: G·ª≠i s·ªë l·ªói v·ªÅ Server
            };
            
            console.log("WIN! Submitting:", payload);

            const res = await fetch(SUBMIT_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            const result = await res.json();
            
            if (result.success) {
                finalScore = result.score; // L·∫•y ƒëi·ªÉm chu·∫©n t·ª´ Server
            }
            
            showWin(finalScore, timeUsed);

        } catch (e) {
            console.error(e);
            // V·∫´n hi·ªán th·∫Øng d√π l·ªói m·∫°ng
            showWin(finalScore, timeUsed);
        }
    }

    function showWin(score, timeUsed) {
        const overlay = document.getElementById("resultOverlay");
        const title = document.getElementById("resultTitle");
        const msg = document.getElementById("resultMsg");
        const timeMsg = document.getElementById("resultTime");
        const btnContainer = document.getElementById("resultButtons");

        overlay.classList.remove("hidden");
        title.textContent = "üéâ CHI·∫æN TH·∫ÆNG!";
        title.style.color = "#4caf50";
        
        // Hi·ªÉn th·ªã gi·ªëng Round 2
        msg.innerHTML = `
            <div style="font-size: 1.1rem; color: #555; margin-bottom: 5px;">B·∫°n sai ${wrongCount} l·∫ßn</div>
            <div style="font-size: 2.5rem; color: #d84315; font-weight: bold;">${score} ƒêi·ªÉm</div>
        `;
        
        timeMsg.textContent = `Th·ªùi gian ho√†n th√†nh: ${formatTimeUsed(timeUsed)}`;

        btnContainer.innerHTML = `
            <button class="btn-next" onclick="goToRound2()">Qua Round 2 ‚ûú</button>
            <button class="btn-next" style="background:#ddd; color:#333; margin-left:10px" onclick="location.href='menu.html'">V·ªÅ Menu</button>
        `;
    }

    function showLose(reason) {
        const overlay = document.getElementById("resultOverlay");
        const title = document.getElementById("resultTitle");
        const msg = document.getElementById("resultMsg");
        const timeMsg = document.getElementById("resultTime");
        const btnContainer = document.getElementById("resultButtons");

        overlay.classList.remove("hidden");
        title.textContent = "üò≠ GAME OVER!";
        title.style.color = "#d32f2f";
        
        msg.innerHTML = `<span style="font-size:1.2rem">${reason}</span><br>B·∫°n b·ªã tr·ª´ h·∫øt ƒëi·ªÉm r·ªìi!`;
        timeMsg.textContent = ""; 

        btnContainer.innerHTML = `
            <button class="btn-next" style="background:#ff9800" onclick="location.reload()">üîÑ Ch∆°i L·∫°i</button>
            <button class="btn-next" style="background:#9e9e9e; margin-left:10px" onclick="location.href='menu.html'">Tho√°t</button>
        `;
    }

    function goToRound2() {
        localStorage.setItem("gameConfig_Round", 2);
        window.location.href = "round2.html";
    }
</script>

</body>
</html>