<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Round 2: Sentence Scramble - Mushroom Kingdom</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">

<style>
    /* --- CSS STYLE --- */
    * { margin: 0; padding: 0; box-sizing: border-box; font-family: "Poppins", Arial, sans-serif; }

    body {
        height: 100vh; width: 100vw; background: #000;
        display: flex; justify-content: center; align-items: center; overflow: hidden;
        background-image: url('screen/mushroom.jpg'); 
        background-size: cover; background-position: center;
    }

    .bg-overlay { position: absolute; inset: 0; background: rgba(0, 0, 0, 0.4); backdrop-filter: blur(4px); z-index: 0; }
    .overlay-ui { position: fixed; inset: 0; pointer-events: none; z-index: 100; }
    
    /* User Info */
    .top-right {
        position: absolute; top: 15px; right: 20px;
        background: rgba(255, 245, 210, 0.95); padding: 8px 16px; border-radius: 999px;
        display: flex; align-items: center; gap: 12px; border: 2px solid #ffb347;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.25); pointer-events: auto;
    }
    .username-label { font-weight: 600; color: #553300; }
    .logout-btn { cursor: pointer; padding: 4px 10px; border-radius: 999px; border: none; background: #ff4b3a; color: #fff; font-size: 0.85rem; box-shadow: 0 3px 0 #c53120; text-transform: uppercase; }
    .logout-btn:hover { transform: translateY(-1px); }

    /* Back Button */
    .bottom-left { position: absolute; left: 20px; bottom: 15px; pointer-events: auto; }
    .btn-back { padding: 7px 16px; border-radius: 999px; border: none; background: #ffffff; color: #553300; cursor: pointer; display: inline-flex; align-items: center; gap: 6px; box-shadow: 0 3px 0 rgba(0, 0, 0, 0.2); text-decoration: none; font-weight: 600;}
    .btn-back:hover { transform: translateY(-1px); }

    /* --- GAME BOARD --- */
    #gameWrapper {
        position: relative; z-index: 10;
        width: 1000px; max-width: 95vw; height: 80vh;
        background: rgba(255, 255, 255, 0.95);
        border-radius: 20px; border: 6px solid #42a5ff;
        box-shadow: 0 15px 40px rgba(0,0,0,0.5);
        display: flex; flex-direction: column; overflow: hidden;
    }

    .game-header {
        height: 70px; background: #e3f2fd;
        display: flex; align-items: center; justify-content: space-between;
        padding: 0 30px; border-bottom: 3px solid #90caf9;
    }

    .game-title { font-size: 1.5rem; font-weight: 700; color: #1565c0; }
    .game-stats { font-size: 1.1rem; font-weight: 600; color: #0d47a1; display: flex; gap: 20px; }
    .stat-box span { color: #d32f2f; font-weight: 700; }

    /* --- KHU V·ª∞C GAME --- */
    .scramble-area {
        flex: 1; display: flex; flex-direction: column;
        padding: 30px; gap: 20px; align-items: center;
        overflow-y: auto;
    }

    .question-progress { font-size: 1.2rem; font-weight: 700; color: #555; margin-bottom: 10px; }

    .answer-zone {
        width: 100%; min-height: 80px;
        background: #fff; border: 3px dashed #bbb; border-radius: 15px;
        display: flex; flex-wrap: wrap; justify-content: center; align-items: center;
        padding: 15px; gap: 10px; transition: all 0.3s;
    }
    .answer-zone.correct { border-color: #4caf50; background: #e8f5e9; }
    .answer-zone.wrong { border-color: #f44336; background: #ffebee; animation: shake 0.4s; }

    .word-bank {
        width: 100%; display: flex; flex-wrap: wrap; justify-content: center;
        gap: 12px; padding: 20px;
        background: #f5f5f5; border-radius: 15px;
    }

    .word-chip {
        background: #fff; border: 2px solid #2196f3; border-bottom: 4px solid #1976d2;
        border-radius: 10px; padding: 10px 20px;
        font-size: 1.2rem; font-weight: 600; color: #333;
        cursor: pointer; user-select: none; transition: all 0.2s;
    }
    .word-chip:hover { transform: translateY(-2px); background: #e3f2fd; }
    .word-chip:active { transform: translateY(2px); border-bottom-width: 2px; }

    .action-area { margin-top: auto; display: flex; gap: 15px; }
    .btn-action { padding: 12px 30px; font-size: 1.1rem; font-weight: bold; color: white; border: none; border-radius: 50px; cursor: pointer; box-shadow: 0 4px 0 rgba(0,0,0,0.2); }
    .btn-check { background: #ff9800; box-shadow: 0 4px 0 #e65100; }
    .btn-check:hover { transform: translateY(-2px); }
    .btn-check:disabled { background: #ccc; box-shadow: none; cursor: not-allowed; transform: none; }

    /* OVERLAYS */
    #loadingOverlay, #resultOverlay {
        position: absolute; inset: 0; background: rgba(255,255,255,0.98);
        z-index: 20; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center;
    }
    .hidden { display: none !important; }

    .result-box {
        background: #fff; padding: 40px 60px; border-radius: 20px;
        border: 4px solid #42a5ff; box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        display: flex; flex-direction: column; align-items: center;
    }
    .result-title { font-size: 2.5rem; color: #1565c0; margin-bottom: 15px; font-weight: 800; }
    .result-score { font-size: 1.8rem; color: #333; margin-bottom: 10px; }
    .result-time { font-size: 1.2rem; color: #555; margin-bottom: 30px; font-style: italic;}
    
    .btn-home { 
        padding: 12px 35px; border: none; border-radius: 50px; 
        font-weight: bold; cursor: pointer; font-size: 1.1rem; color: white;
        transition: transform 0.2s; box-shadow: 0 4px 0 rgba(0,0,0,0.2);
        margin: 5px;
    }
    .btn-home:hover { transform: translateY(-2px); }
    .btn-primary { background: #4caf50; } /* M√†u xanh l√° cho n√∫t NEXT */
    .btn-retry { background: #ff9800; }
    .btn-secondary { background: #9e9e9e; }

    @keyframes shake {
        0%, 100% { transform: translateX(0); }
        25% { transform: translateX(-5px); }
        75% { transform: translateX(5px); }
    }
</style>
</head>
<body>

<div class="bg-overlay"></div>

<div class="overlay-ui">
    <div class="top-right">
        <span class="username-label" id="showUser">User</span>
        <button class="logout-btn" onclick="logout()">Logout</button>
    </div>
    <div class="bottom-left">
        <a href="level.html" class="btn-back"><span>‚Üê</span> Tr·ªü l·∫°i</a>
    </div>
</div>

<div id="gameWrapper">
    <div class="game-header">
        <div class="game-title" id="gameTitleDisplay">üåä Round 2: Tr·∫≠t t·ª± c√¢u</div>
        <div class="game-stats">
            <div class="stat-box">C√¢u: <span id="questionCount">1</span>/10</div>
            <div class="stat-box">ƒêi·ªÉm: <span id="scoreDisplay">0</span></div>
            <div class="stat-box">C√≤n l·∫°i: <span id="timerDisplay">--:--</span></div>
        </div>
    </div>

    <div id="loadingOverlay">
        <h2 style="color:#1565c0; margin-bottom:10px">ƒêang t·∫£i c√¢u h·ªèi...</h2>
        <p>Vui l√≤ng ƒë·ª£i trong gi√¢y l√°t</p>
    </div>

    <div class="scramble-area" id="gameArea">
        <div class="question-progress" id="progressText">C√¢u h·ªèi 1 / 10</div>
        <div class="answer-zone" id="answerZone"></div> 
        <div class="word-bank" id="wordBank"></div>
        <div class="action-area">
            <button class="btn-action btn-check" id="btnCheck" onclick="checkAnswer()">Ki·ªÉm tra</button>
        </div>
    </div>

    <div id="resultOverlay" class="hidden">
        <div class="result-box">
            <div class="result-title" id="resultTitle">Ho√†n th√†nh!</div>
            <div class="result-score" id="resultMsg">T·ªïng ƒëi·ªÉm: ...</div>
            <div class="result-time" id="resultTime">Th·ªùi gian: ...</div>
            
            <div id="resultButtons">
                </div>
        </div>
    </div>
</div>

<script>
    // ============ C·∫§U H√åNH API ============
    const BASE_API_URL = 'http://localhost:5000/api/game/round2'; 
    const SUBMIT_URL = 'http://localhost:5000/api/game/submit-round2';
    
    // BI·∫æN TR·∫†NG TH√ÅI
    let GAME_DURATION = 120;
    let unitId = null;
    let difficulty = 'normal';

    let sentencesData = [];
    let currentQuestionIndex = 0;
    let currentScore = 0;
    let currentWords = [];
    let userArrangement = [];
    
    let timerInterval;
    let timeLeft = 0;

    // ============ KH·ªûI T·∫†O GAME ============
    window.onload = function() {
        const userId = localStorage.getItem("currentUserID");
        const fullname = localStorage.getItem("fullname");
        const username = localStorage.getItem("username");
        document.getElementById("showUser").textContent = fullname || username || "Guest";

        // L·∫•y Unit & Diff t·ª´ trang tr∆∞·ªõc
        unitId = localStorage.getItem("gameConfig_UnitId");
        difficulty = localStorage.getItem("gameConfig_Diff") || 'normal';

        if (!unitId) {
            alert("Vui l√≤ng ch·ªçn b√†i h·ªçc tr∆∞·ªõc!");
            window.location.href = "UnitSelect.html";
            return;
        }

        setupDifficulty(difficulty);
        document.getElementById("gameTitleDisplay").textContent = `üåä Unit ${unitId} (${capitalize(difficulty)})`;
        
        fetchGameData(unitId);
    };

    function setupDifficulty(diff) {
        if (diff === 'easy') GAME_DURATION = 180;
        else if (diff === 'hard') GAME_DURATION = 60;
        else GAME_DURATION = 120;
        
        timeLeft = GAME_DURATION;
        updateTimerDisplay();
    }

    function capitalize(s) { return s && s[0].toUpperCase() + s.slice(1); }
    function logout() { if(confirm("Tho√°t game?")) { localStorage.clear(); window.location.href = "login.html"; } }

    // ============ API: L·∫§Y C√ÇU H·ªéI ============
    async function fetchGameData(id) {
        try {
            const res = await fetch(`${BASE_API_URL}/${id}`);
            if (!res.ok) throw new Error(`Server Error: ${res.status}`);
            const data = await res.json();

            if (data.success) {
                if (!data.data || data.data.length === 0) {
                    alert("L·ªói: Unit n√†y ch∆∞a c√≥ c√¢u h·ªèi!");
                    return;
                }
                sentencesData = data.data; 
                currentQuestionIndex = 0;
                currentScore = 0; 
                document.getElementById("scoreDisplay").textContent = currentScore;
                
                document.getElementById("loadingOverlay").classList.add("hidden");
                startTimer();
                loadQuestion(currentQuestionIndex);
            } else {
                alert("L·ªói server: " + data.message);
            }
        } catch (e) {
            console.error(e);
            alert("L·ªói k·∫øt n·ªëi! ƒê·∫£m b·∫£o Backend ƒëang ch·∫°y.");
        }
    }

    // ============ LOGIC TH·ªúI GIAN ============
    function startTimer() {
        updateTimerDisplay();
        clearInterval(timerInterval);
        timerInterval = setInterval(() => {
            timeLeft--;
            updateTimerDisplay();
            if (timeLeft <= 0) {
                clearInterval(timerInterval);
                alert("H·∫øt gi·ªù!");
                finishGame();
            }
        }, 1000);
    }

    function updateTimerDisplay() {
        let t = timeLeft < 0 ? 0 : timeLeft;
        const m = Math.floor(t / 60).toString().padStart(2, '0');
        const s = (t % 60).toString().padStart(2, '0');
        const el = document.getElementById("timerDisplay");
        el.textContent = `${m}:${s}`;
        el.style.color = t < 10 ? "red" : "#0d47a1";
    }

    function formatTimeUsed(seconds) {
        const m = Math.floor(seconds / 60).toString().padStart(2, '0');
        const s = (seconds % 60).toString().padStart(2, '0');
        return `${m}:${s}`;
    }

    function stopTimer() { clearInterval(timerInterval); }

    // ============ GAMEPLAY LOGIC ============
    function shuffle(array) { return array.sort(() => Math.random() - 0.5); }

    function loadQuestion(index) {
        const sentenceObj = sentencesData[index];
        const rawContent = sentenceObj.OptionContent || sentenceObj.optionContent;
        if (!rawContent) return;

        const fullSentence = rawContent.trim();
        // B·ªè d·∫•u c√¢u cu·ªëi ƒë·ªÉ tr√°nh l·ªô
        const cleanSentence = fullSentence.replace(/[.!?]$/, ''); 
        let words = cleanSentence.split(/\s+/);
        
        sentencesData[index].correctString = cleanSentence;
        currentWords = shuffle([...words]); 
        userArrangement = [];

        document.getElementById("progressText").textContent = `C√¢u h·ªèi ${index + 1} / ${sentencesData.length}`;
        document.getElementById("questionCount").textContent = index + 1;
        document.getElementById("answerZone").className = "answer-zone";
        document.getElementById("btnCheck").disabled = false;
        
        renderZones();
    }

    function renderZones() {
        const answerZone = document.getElementById("answerZone");
        const wordBank = document.getElementById("wordBank");
        answerZone.innerHTML = "";
        wordBank.innerHTML = "";

        // Render V√πng Tr·∫£ L·ªùi
        if (userArrangement.length === 0) {
            const placeholder = document.createElement("span");
            placeholder.textContent = "Ch·ªçn t·ª´ b√™n d∆∞·ªõi ƒë·ªÉ x·∫øp th√†nh c√¢u...";
            placeholder.style.color = "#999";
            placeholder.style.fontStyle = "italic";
            placeholder.style.pointerEvents = "none";
            answerZone.appendChild(placeholder);
        } else {
            userArrangement.forEach((word, idx) => {
                answerZone.appendChild(createChip(word, () => moveToBank(idx)));
            });
        }

        // Render Ng√¢n H√†ng T·ª´
        currentWords.forEach((word, idx) => {
            wordBank.appendChild(createChip(word, () => moveToAnswer(idx)));
        });
    }

    function createChip(text, onClickHandler) {
        const div = document.createElement("div");
        div.className = "word-chip";
        div.textContent = text;
        div.onclick = onClickHandler;
        return div;
    }

    function moveToAnswer(bankIndex) {
        const word = currentWords[bankIndex];
        currentWords.splice(bankIndex, 1);
        userArrangement.push(word);
        renderZones();
    }

    function moveToBank(ansIndex) {
        const word = userArrangement[ansIndex];
        userArrangement.splice(ansIndex, 1);
        currentWords.push(word);
        renderZones();
    }

    // ============ LOGIC CH·∫§M ƒêI·ªÇM ============
    function checkAnswer() {
        const btnCheck = document.getElementById("btnCheck");
        const answerZone = document.getElementById("answerZone");

        const userString = userArrangement.join(" ");
        const correctString = sentencesData[currentQuestionIndex].correctString;

        if (userString === correctString) {
            // --- ƒê√öNG ---
            answerZone.classList.add("correct");
            currentScore += 1; 
            document.getElementById("scoreDisplay").textContent = currentScore;
            
            btnCheck.disabled = true;
            setTimeout(() => { nextQuestion(); }, 1000);
        } else {
            // --- SAI ---
            answerZone.classList.add("wrong");
            
            // Tr·ª´ 1 ƒëi·ªÉm (nh∆∞ng kh√¥ng √¢m)
            currentScore = Math.max(0, currentScore - 1);
            document.getElementById("scoreDisplay").textContent = currentScore;

            // Rung l·∫Øc b√°o sai v√† cho ph√©p s·ª≠a l·∫°i
            setTimeout(() => { 
                answerZone.classList.remove("wrong"); 
            }, 800);
        }
    }

    function nextQuestion() {
        currentQuestionIndex++;
        if (currentQuestionIndex < sentencesData.length) {
            loadQuestion(currentQuestionIndex);
        } else {
            finishGame();
        }
    }

    // ============ K·∫æT TH√öC GAME ============
    async function finishGame() {
        stopTimer();
        
        const timeUsed = GAME_DURATION - timeLeft;
        const formattedTime = formatTimeUsed(timeUsed);
        const userId = localStorage.getItem("currentUserID");

        const title = document.getElementById("resultTitle");
        const msg = document.getElementById("resultMsg");
        const timeMsg = document.getElementById("resultTime");
        const btnContainer = document.getElementById("resultButtons");

        // Logic Pass/Fail
        const isPassed = currentScore >= 5;
        
        title.textContent = isPassed ? "üéâ HO√ÄN TH√ÄNH!" : "üò¢ R·∫§T TI·∫æC!";
        title.style.color = isPassed ? "#4caf50" : "#f44336";
        msg.textContent = `T·ªïng ƒëi·ªÉm: ${currentScore}/10`;
        timeMsg.textContent = `Th·ªùi gian ho√†n th√†nh: ${formattedTime}`;

        // X√≥a n√∫t c≈©, t·∫°o n√∫t m·ªõi
        btnContainer.innerHTML = ""; 

        if (isPassed) {
            // ƒê·∫¨U: N√∫t Qua Round 3
            const btnNext = document.createElement("button");
            btnNext.className = "btn-home btn-primary";
            btnNext.textContent = "Qua Round 3";
            btnNext.onclick = () => {
                localStorage.setItem("gameConfig_Round", 3);
                window.location.href = "round3.html"; // Gi·∫£ ƒë·ªãnh c√≥ file n√†y
            };
            btnContainer.appendChild(btnNext);
        } else {
            // R·ªöT: N√∫t Th·ª≠ l·∫°i
            const btnRetry = document.createElement("button");
            btnRetry.className = "btn-home btn-retry";
            btnRetry.textContent = "Th·ª≠ l·∫°i ngay";
            btnRetry.onclick = () => location.reload();
            btnContainer.appendChild(btnRetry);

            // N√∫t Tho√°t
            const btnExit = document.createElement("button");
            btnExit.className = "btn-home btn-secondary";
            btnExit.textContent = "V·ªÅ Menu";
            btnExit.onclick = () => window.location.href = "menu.html";
            btnContainer.appendChild(btnExit);
        }

        document.getElementById("resultOverlay").classList.remove("hidden");

        // L∆∞u ƒëi·ªÉm v√†o DB
        try {
            await fetch(SUBMIT_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    studentId: userId,
                    userId: userId,
                    score: currentScore,
                    timeTaken: timeUsed 
                })
            });
            console.log("ƒê√£ l∆∞u k·∫øt qu·∫£.");
        } catch (e) {
            console.error("L·ªói l∆∞u ƒëi·ªÉm:", e);
        }
    }
</script>

</body>
</html>