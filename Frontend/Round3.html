<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Round 3: Multiple Choice - Survival Mode</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<style>
    /* --- CSS GI·ªÆ NGUY√äN --- */
    * { margin: 0; padding: 0; box-sizing: border-box; font-family: "Poppins", Arial, sans-serif; }

    body {
        height: 100vh; width: 100vw; background: #000;
        display: flex; justify-content: center; align-items: center; overflow: hidden;
        background-image: url('screen/mushroom.jpg'); 
        background-size: cover; background-position: center;
    }

    .bg-overlay { position: absolute; inset: 0; background: rgba(0, 0, 0, 0.4); backdrop-filter: blur(4px); z-index: 0; }
    .overlay-ui { position: fixed; inset: 0; pointer-events: none; z-index: 100; }
    
    .top-right {
        position: absolute; top: 15px; right: 20px;
        background: rgba(255, 245, 210, 0.95); padding: 8px 16px; border-radius: 999px;
        display: flex; align-items: center; gap: 12px; border: 2px solid #ffb347;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.25); pointer-events: auto;
    }
    .username-label { font-weight: 600; color: #553300; }
    .logout-btn { cursor: pointer; padding: 4px 10px; border-radius: 999px; border: none; background: #ff4b3a; color: #fff; font-size: 0.85rem; box-shadow: 0 3px 0 #c53120; text-transform: uppercase; }
    .logout-btn:hover { transform: translateY(-1px); }

    .bottom-left { position: absolute; left: 20px; bottom: 15px; pointer-events: auto; }
    .btn-back { padding: 7px 16px; border-radius: 999px; border: none; background: #ffffff; color: #553300; cursor: pointer; display: inline-flex; align-items: center; gap: 6px; box-shadow: 0 3px 0 rgba(0, 0, 0, 0.2); text-decoration: none; font-weight: 600;}
    .btn-back:hover { transform: translateY(-1px); }

    /* --- GAME BOARD --- */
    #gameWrapper {
        position: relative; z-index: 10;
        width: 1000px; max-width: 95vw; height: 85vh;
        background: rgba(255, 255, 255, 0.96);
        border-radius: 20px; border: 6px solid #9c27b0;
        box-shadow: 0 15px 40px rgba(0,0,0,0.5);
        display: flex; flex-direction: column; overflow: hidden;
    }

    .game-header {
        height: 75px; background: #f3e5f5;
        display: flex; align-items: center; justify-content: space-between;
        padding: 0 30px; border-bottom: 3px solid #ce93d8;
    }

    .game-title { font-size: 1.5rem; font-weight: 700; color: #7b1fa2; }
    .game-stats { font-size: 1.1rem; font-weight: 600; color: #4a148c; display: flex; gap: 20px; }
    .stat-box span { color: #d32f2f; font-weight: 700; }

    /* --- KHU V·ª∞C C√ÇU H·ªéI --- */
    .quiz-area {
        flex: 1; display: flex; flex-direction: column;
        padding: 30px; align-items: center; overflow-y: auto;
    }

    .question-box {
        width: 100%; text-align: center; margin-bottom: 25px;
        background: #fff; padding: 25px; border-radius: 15px;
        border: 3px solid #e1bee7; box-shadow: 0 5px 15px rgba(0,0,0,0.05);
    }
    .question-text { font-size: 1.6rem; font-weight: 700; color: #333; line-height: 1.4; }

    .options-grid {
        display: grid; grid-template-columns: 1fr 1fr; gap: 20px; width: 100%;
    }
    
    .option-btn {
        background: #fff; border: 3px solid #e0e0e0; padding: 20px;
        border-radius: 15px; font-size: 1.3rem; color: #555; font-weight: 600;
        cursor: pointer; transition: 0.2s; box-shadow: 0 4px 0 #ccc;
        position: relative; overflow: hidden;
    }
    .option-btn:hover:not(:disabled) { transform: translateY(-3px); background: #f3e5f5; border-color: #9c27b0; color: #7b1fa2; }
    .option-btn:active:not(:disabled) { transform: translateY(2px); box-shadow: none; }
    
    .option-btn.correct { background: #4caf50 !important; color: white !important; border-color: #2e7d32 !important; box-shadow: 0 4px 0 #1b5e20 !important; }
    .option-btn.wrong { background: #ffebee !important; color: #d32f2f !important; border-color: #f44336 !important; animation: shake 0.4s; }
    .option-btn:disabled { cursor: not-allowed; opacity: 0.7; }

    /* OVERLAYS */
    #loadingOverlay, #resultOverlay {
        position: absolute; inset: 0; background: rgba(255,255,255,0.98);
        z-index: 20; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center;
    }
    .hidden { display: none !important; }

    .result-box {
        background: #fff; padding: 40px 60px; border-radius: 20px;
        border: 4px solid #9c27b0; box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        display: flex; flex-direction: column; align-items: center;
        animation: popIn 0.3s;
    }
    @keyframes popIn { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }

    .result-title { font-size: 2.5rem; color: #7b1fa2; margin-bottom: 15px; font-weight: 800; }
    .result-score { font-size: 1.8rem; color: #333; margin-bottom: 10px; }
    .result-time { font-size: 1.2rem; color: #555; margin-bottom: 30px; font-style: italic;}
    
    .btn-home { 
        padding: 12px 35px; border: none; border-radius: 50px; 
        font-weight: bold; cursor: pointer; font-size: 1.1rem; color: white;
        transition: transform 0.2s; box-shadow: 0 4px 0 rgba(0,0,0,0.2); margin: 5px;
    }
    .btn-home:hover { transform: translateY(-2px); }
    .btn-primary { background: #4caf50; } 
    .btn-retry { background: #ff9800; }
    .btn-secondary { background: #9e9e9e; }

    @keyframes shake {
        0%, 100% { transform: translateX(0); }
        25% { transform: translateX(-6px); }
        75% { transform: translateX(6px); }
    }
</style>
</head>
<body>

<div class="bg-overlay"></div>

<div class="overlay-ui">
    <div class="top-right">
        <span class="username-label" id="showUser">User</span>
        <button class="logout-btn" onclick="logout()">Logout</button>
    </div>
    <div class="bottom-left">
        <a href="UnitSelect.html" class="btn-back"><span>‚Üê</span> Tr·ªü l·∫°i</a>
    </div>
</div>

<div id="gameWrapper">
    <div class="game-header">
        <div class="game-title" id="gameTitleDisplay">üîÆ Round 3: Tr·∫Øc nghi·ªám</div>
        <div class="game-stats">
            <div class="stat-box" style="color: #d32f2f;">L·ªói: <span id="wrongDisplay">0</span>/5</div>
            <div class="stat-box">C√¢u: <span id="questionCount">1</span>/10</div>
            <div class="stat-box">ƒê√∫ng: <span id="scoreDisplay">0</span></div>
            <div class="stat-box">C√≤n l·∫°i: <span id="timerDisplay">--:--</span></div>
        </div>
    </div>

    <div id="loadingOverlay">
        <h2 style="color:#7b1fa2; margin-bottom:10px">ƒêang t·∫£i c√¢u h·ªèi...</h2>
        <div class="spinner"><i class="fas fa-circle-notch fa-spin fa-2x" style="color:#ce93d8"></i></div>
    </div>

    <div class="quiz-area" id="gameArea">
        <div class="question-box">
            <div class="question-text" id="qText">...</div>
        </div>
        <div class="options-grid" id="optGrid">
        </div>
    </div>

    <div id="resultOverlay" class="hidden">
        <div class="result-box">
            <div class="result-title" id="resultTitle">Ho√†n th√†nh!</div>
            <div class="result-score" id="resultMsg">T·ªïng ƒëi·ªÉm: ...</div>
            <div class="result-time" id="resultTime">Th·ªùi gian: ...</div>
            <div id="resultButtons"></div>
        </div>
    </div>
</div>

<script>
    // ============ C·∫§U H√åNH API ============
    const API_URL = '/api/game';
    const SUBMIT_URL = '/api/game/submit-round3'; // Tr·ªè v·ªÅ saveGameResult
    
    // BI·∫æN TR·∫†NG TH√ÅI
    let GAME_DURATION = 120;
    let unitId = null;
    let selectedGrade = 5;
    let difficulty = 'normal';

    let questionsData = [];
    let currIdx = 0;
    let currentScore = 0; // S·ªë c√¢u ƒë√∫ng
    let timerInterval;
    let timeLeft = 0;
    let isAnswering = false; 

    // Logic Survival
    let wrongCount = 0;
    const MAX_WRONG = 5;

    let userAnswers = []; 

    // ============ KH·ªûI T·∫†O GAME ============
    window.onload = function() {
        const userId = localStorage.getItem("currentUserID");
        const fullname = localStorage.getItem("fullname");
        document.getElementById("showUser").textContent = fullname || "Guest";

        unitId = localStorage.getItem("currentUnitId");
        difficulty = localStorage.getItem("gameConfig_Diff") || 'normal';
        selectedGrade = localStorage.getItem("selectedGrade") || 5;

        if (!unitId) {
            alert("Vui l√≤ng ch·ªçn b√†i h·ªçc tr∆∞·ªõc!");
            window.location.href = "UnitSelect.html";
            return;
        }

        setupDifficulty(difficulty);
        document.getElementById("gameTitleDisplay").textContent = `üîÆ L·ªõp ${selectedGrade} - Unit ${unitId} (${capitalize(difficulty)})`;
        
        fetchGameData(unitId);
    };

    function setupDifficulty(diff) {
        if (diff === 'easy') GAME_DURATION = 180;
        else if (diff === 'hard') GAME_DURATION = 60;
        else GAME_DURATION = 120;
        
        timeLeft = GAME_DURATION;
        updateTimerDisplay();
    }

    function capitalize(s) { return s && s[0].toUpperCase() + s.slice(1); }
    function logout() { if(confirm("Tho√°t game?")) { localStorage.clear(); window.location.href = "login.html"; } }

    // ============ API: L·∫§Y C√ÇU H·ªéI ============
    async function fetchGameData(id) {
        try {
            const res = await fetch(`${API_URL}/round3/${id}?grade=${selectedGrade}`);
            if (!res.ok) throw new Error(`L·ªói Server: ${res.status}`);
            
            const data = await res.json();
            
            if (data.success) {
                if (!data.data || data.data.length === 0) throw new Error("Kh√¥ng c√≥ d·ªØ li·ªáu c√¢u h·ªèi.");
                
                questionsData = data.data;
                
                currIdx = 0;
                currentScore = 0;
                wrongCount = 0;
                userAnswers = [];
                
                updateScoreUI();
                
                document.getElementById("loadingOverlay").classList.add("hidden");
                startTimer();
                renderQuestion();
            } else {
                throw new Error(data.message);
            }
        } catch (e) {
            alert("L·ªói t·∫£i d·ªØ li·ªáu: " + e.message);
        }
    }

    // ============ LOGIC TH·ªúI GIAN ============
    function startTimer() {
        updateTimerDisplay();
        clearInterval(timerInterval);
        timerInterval = setInterval(() => {
            timeLeft--;
            updateTimerDisplay();
            if (timeLeft <= 0) {
                clearInterval(timerInterval);
                showLose("H·∫øt gi·ªù!");
            }
        }, 1000);
    }

    function updateTimerDisplay() {
        let t = timeLeft < 0 ? 0 : timeLeft;
        const m = Math.floor(t / 60).toString().padStart(2, '0');
        const s = (t % 60).toString().padStart(2, '0');
        const el = document.getElementById("timerDisplay");
        el.textContent = `${m}:${s}`;
        el.style.color = t < 15 ? "#d32f2f" : "#4a148c"; 
    }

    // ============ GAMEPLAY LOGIC ============
    function renderQuestion() {
        isAnswering = false;
        const q = questionsData[currIdx];
        
        document.getElementById("questionCount").textContent = currIdx + 1;
        document.getElementById("qText").textContent = q.question;
        
        const grid = document.getElementById("optGrid");
        grid.innerHTML = ""; 

        q.options.forEach(opt => {
            const btn = document.createElement("button");
            btn.className = "option-btn";
            btn.textContent = opt.text;
            btn.onclick = () => handleAnswer(btn, opt, q);
            grid.appendChild(btn);
        });
    }

    function handleAnswer(btnElement, optionData, questionData) {
        if (isAnswering) return; 
        isAnswering = true; // Ch·∫∑n click li√™n t·ª•c
        
        // 1. Ki·ªÉm tra ƒë√∫ng sai
        const rawValue = (optionData.IsCorrect !== undefined) ? optionData.IsCorrect : optionData.isCorrect;
        let isCorrect = false;
        if (rawValue === true || rawValue === 1 || String(rawValue).toLowerCase() === "true") {
            isCorrect = true;
        } 

        // 2. L∆∞u ƒë√°p √°n
        userAnswers.push({
            questionId: questionData.id,
            selectedOptionId: optionData.id
        });

        // 3. X·ª≠ l√Ω hi·ªÉn th·ªã v√† ƒëi·ªÉm s·ªë
        if (isCorrect) {
            btnElement.classList.add("correct");
            currentScore++;
            updateScoreUI();
            
            // Chuy·ªÉn c√¢u ti·∫øp theo sau 1s
            setTimeout(() => { nextQuestion(); }, 1000);
        } else {
            // --- SAI ---
            btnElement.classList.add("wrong");
            wrongCount++;
            updateScoreUI(); // C·∫≠p nh·∫≠t s·ªë l·ªói

            // Hi·ªÉn th·ªã ƒë√°p √°n ƒë√∫ng ƒë·ªÉ ng∆∞·ªùi ch∆°i bi·∫øt
            const buttons = document.querySelectorAll('.option-btn');
            buttons.forEach(b => {
                // Logic t√¨m n√∫t ƒë√∫ng h∆°i ph·ª©c t·∫°p v√¨ ta ch·ªâ c√≥ text ·ªü ƒë√¢y, 
                // nh∆∞ng ƒë∆°n gi·∫£n nh·∫•t l√† ch·ªâ highlight c√°i sai r·ªìi qua c√¢u.
                // N·∫øu mu·ªën highlight ƒë√∫ng: c·∫ßn loop qua questionData.options ƒë·ªÉ t√¨m c√°i ƒë√∫ng
            });

            // Ki·ªÉm tra THUA
            if (wrongCount > MAX_WRONG) {
                clearInterval(timerInterval);
                setTimeout(() => {
                    showLose(`B·∫°n ƒë√£ sai qu√° ${MAX_WRONG} l·∫ßn!`);
                }, 800);
            } else {
                // V·∫´n c√≤n m·∫°ng -> chuy·ªÉn c√¢u ti·∫øp theo
                setTimeout(() => { nextQuestion(); }, 1000);
            }
        }
    }

    function updateScoreUI() {
        document.getElementById("scoreDisplay").textContent = currentScore;
        document.getElementById("wrongDisplay").textContent = wrongCount;
    }

    function nextQuestion() {
        currIdx++;
        if (currIdx < questionsData.length) {
            renderQuestion();
        } else {
            finishGame();
        }
    }

    // ============ K·∫æT TH√öC GAME ============
    async function finishGame() {
        clearInterval(timerInterval);
        
        const timeUsed = GAME_DURATION - timeLeft;
        const formattedTime = `${Math.floor(timeUsed/60).toString().padStart(2,'0')}:${(timeUsed%60).toString().padStart(2,'0')}`;
        const userId = localStorage.getItem("currentUserID");
        
        // ƒêi·ªÉm hi·ªÉn th·ªã t·∫°m th·ªùi: 100 - (L·ªói * 10)
        let finalScore = 100 - (wrongCount * 10);
        if (finalScore < 0) finalScore = 0;

        // Ch·ªâ g·ª≠i ƒëi·ªÉm n·∫øu ch∆∞a thua (logic ƒë√£ ch·∫∑n ·ªü handleAnswer r·ªìi, nh∆∞ng check l·∫°i cho ch·∫Øc)
        if (wrongCount <= MAX_WRONG) {
            try {
                console.log("G·ª≠i k·∫øt qu·∫£:", { userId, score: currentScore, wrongCount }); 

                const res = await fetch(SUBMIT_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        studentId: userId,
                        gameId: 3, // Round 3
                        topicId: unitId,
                        timeTaken: timeUsed,
                        totalQuestions: questionsData.length,
                        correctCount: currentScore,
                        wrongCount: wrongCount // <--- G·ª≠i s·ªë l·ªói
                    })
                });
                
                const result = await res.json();
                if(result.success) finalScore = result.score; // L·∫•y ƒëi·ªÉm chu·∫©n server

                showWin(finalScore, formattedTime);

            } catch (e) {
                console.error("L·ªói l∆∞u ƒëi·ªÉm:", e);
                showWin(finalScore, formattedTime); // V·∫´n hi·ªán k·∫øt qu·∫£
            }
        } else {
            showLose("Sai qu√° nhi·ªÅu!");
        }
    }

    // HI·ªÇN TH·ªä TH·∫ÆNG
    function showWin(score, timeFormatted) {
        const overlay = document.getElementById("resultOverlay");
        const title = document.getElementById("resultTitle");
        const msg = document.getElementById("resultMsg");
        const timeMsg = document.getElementById("resultTime");
        const btnContainer = document.getElementById("resultButtons");
        
        overlay.classList.remove("hidden");
        title.textContent = "üéâ XU·∫§T S·∫ÆC!";
        title.style.color = "#4caf50";
        
        msg.innerHTML = `
            <div style="font-size: 1.1rem; color: #555; margin-bottom: 5px;">B·∫°n sai ${wrongCount} c√¢u</div>
            <div style="font-size: 2.5rem; color: #d84315; font-weight: bold;">${score} ƒêi·ªÉm</div>
        `;
        timeMsg.textContent = `Th·ªùi gian: ${timeFormatted}`;
        
        btnContainer.innerHTML = `
            <button class="btn-home btn-primary" onclick="goToRound4()">Qua Round 4 ‚ûú</button>
            <button class="btn-home btn-secondary" onclick="location.href='menu.html'">V·ªÅ Menu</button>
        `;
    }

    // HI·ªÇN TH·ªä THUA
    function showLose(reason) {
        const overlay = document.getElementById("resultOverlay");
        const title = document.getElementById("resultTitle");
        const msg = document.getElementById("resultMsg");
        const timeMsg = document.getElementById("resultTime");
        const btnContainer = document.getElementById("resultButtons");

        overlay.classList.remove("hidden");
        title.textContent = "üò≠ GAME OVER!";
        title.style.color = "#d32f2f";
        
        msg.innerHTML = `<span style="font-size:1.2rem">${reason}</span><br>Kh√¥ng ƒë∆∞·ª£c t√≠nh ƒëi·ªÉm v√°n n√†y.`;
        timeMsg.textContent = "";
        
        btnContainer.innerHTML = `
            <button class="btn-home btn-retry" onclick="location.reload()">üîÑ Th·ª≠ l·∫°i</button>
            <button class="btn-home btn-secondary" onclick="location.href='menu.html'">Tho√°t</button>
        `;
    }

    function goToRound4() {
        localStorage.setItem("gameConfig_Round", 4);
        window.location.href = "round4.html";
    }
</script>

</body>
</html>