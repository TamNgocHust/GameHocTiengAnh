<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Đăng nhập Hệ thống</title>

<style>
    * { margin: 0; padding: 0; box-sizing: border-box; font-family: "Poppins", Arial, sans-serif; }

    body {
        height: 100vh; width: 100vw;
        background: url("screen/phongnen.jpg") no-repeat center center fixed;
        background-size: cover;
        display: flex; justify-content: center; align-items: center;
    }

    .overlay { position: fixed; inset: 0; background: rgba(255, 255, 255, 0.25); }

    .login-card {
        position: relative; z-index: 1; width: 360px;
        padding: 30px; border-radius: 18px;
        background: rgba(255, 245, 210, 0.95);
        box-shadow: 0 15px 40px rgba(0, 0, 0, 0.3);
        border: 3px solid #ff8c42;
    }

    .login-card h1 {
        text-align: center; margin-bottom: 20px; font-size: 1.8rem;
        color: #d13625; text-transform: uppercase; text-shadow: 0 2px 0 #ffd76b;
    }

    label { display: block; margin: 10px 0 5px; font-weight: bold; color: #553300; }

    input {
        width: 100%; padding: 12px; border-radius: 10px;
        border: 2px solid #ffb347; outline: none; font-size: 1rem;
        background: #fffaf0; transition: 0.2s;
    }
    input:focus { border-color: #ff7a29; background: #fff; }

    .login-btn {
        margin-top: 20px; width: 100%; padding: 12px;
        border-radius: 50px; border: none;
        background: #ff4b3a; color: white; font-weight: bold; font-size: 1.1rem;
        cursor: pointer; box-shadow: 0 5px 0 #c53120; transition: 0.1s;
    }
    .login-btn:hover { transform: translateY(-2px); box-shadow: 0 7px 0 #c53120; }
    .login-btn:active { transform: translateY(2px); box-shadow: 0 2px 0 #c53120; }
    .login-btn:disabled { background: #ccc; box-shadow: none; cursor: not-allowed; }

    .message { min-height: 20px; margin-top: 10px; font-size: 0.9rem; text-align: center; }
    .message.error { color: #d32f2f; font-weight: bold; }
    .message.info { color: #0288d1; }

    .links { margin-top: 15px; text-align: center; font-size: 0.9rem; }
    .link { cursor: pointer; text-decoration: underline; color: #553300; margin-top: 5px; }
    .link:hover { color: #d13625; }
</style>
</head>
<body>

<div class="overlay"></div>

<div class="login-card">
    <h1>Đăng nhập</h1>

    <div id="message" class="message"></div>

    <form>
        <label for="username">Tên đăng nhập</label>
        <input type="text" id="username" required placeholder="Nhập tên đăng nhập..." value="student1">

        <label for="password">Mật khẩu</label>
        <input type="password" id="password" required placeholder="Nhập mật khẩu..." value="student">

        <button type="button" class="login-btn" id="btnLogin" onclick="handleLogin()">BẮT ĐẦU</button>
    </form>

    <div class="links">
        <p class="link" onclick="showMessage('Liên hệ GVCN để cấp lại!')">Quên mật khẩu?</p>
        <p class="link" onclick="location.href='home.html'">Quay lại trang chủ</p>
    </div>
</div>

<script>
    async function handleLogin() {
        // 1. Lấy giá trị input
        const usernameIn = document.getElementById("username").value.trim();
        const passwordIn = document.getElementById("password").value.trim();
        const msgBox = document.getElementById("message");
        const btn = document.getElementById("btnLogin");

        // Kiểm tra rỗng
        if (!usernameIn || !passwordIn) {
            msgBox.textContent = "Vui lòng nhập đầy đủ thông tin!";
            msgBox.className = "message error";
            return;
        }

        // 2. Reset trạng thái
        msgBox.textContent = "⏳ Đang kết nối...";
        msgBox.className = "message info";
        btn.disabled = true;

        try {
            // 3. GỌI API (Đảm bảo cổng 5000 là đúng với server.js)
            const response = await fetch("http://localhost:5000/api/auth/login", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ 
                    username: usernameIn, 
                    password: passwordIn 
                })
            });

            const data = await response.json();

            // 4. Xử lý kết quả trả về từ Server
            if (data.success) {
                // --- ĐĂNG NHẬP THÀNH CÔNG ---
                
                // Lưu vào LocalStorage (Sửa lại để khớp với dữ liệu Server trả về)
                // Server trả về: userId, fullName, role (là số ID)
                localStorage.setItem("currentUserID", data.userId); 
                localStorage.setItem("username", usernameIn);
                localStorage.setItem("fullname", data.fullName);
                localStorage.setItem("roleID", data.role); 

                msgBox.textContent = "✅ " + data.message;
                msgBox.className = "message"; 

                // Chuyển trang sau 1 giây
                setTimeout(() => {
                    // Giả sử RoleID = 2 là Giáo viên (dựa trên file SQL cũ)
                    // Nếu RoleID = 3 là Học sinh
                    if (data.role == 2) { 
                        window.location.href = "teacher-menu.html";
                    } else {
                        // Mặc định cho học sinh
                        window.location.href = "menu.html";
                    }
                }, 1000);

            } else {
                // --- SAI TÀI KHOẢN / MẬT KHẨU ---
                msgBox.textContent = "❌ " + data.message;
                msgBox.className = "message error";
                btn.disabled = false;
            }

        } catch (error) {
            // --- LỖI MẤT MẠNG HOẶC SERVER CHẾT ---
            console.error(error);
            msgBox.textContent = "⚠️ Lỗi kết nối Server! Hãy kiểm tra Node.js";
            msgBox.className = "message error";
            btn.disabled = false;
        }
    }

    function showMessage(text) {
        const msgBox = document.getElementById("message");
        msgBox.textContent = text;
        msgBox.className = "message info";
    }
</script>

</body>
</html>